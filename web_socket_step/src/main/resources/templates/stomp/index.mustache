<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js" integrity="sha512-1QvjE7BtotQjkq8PxLeF6P46gEpBRXuskzIVgjFpekzFVF4yjRgrQvTG1MTOJ3yQgvTteKAcO7DSZI92+u/yZw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js" integrity="sha512-iKDtgDyTHjAitUDdLljGhenhPwrbBfqTKWO1mkhSFH3A7blITC9MhYon6SjnMhp4o0rADGw9yAC6EW4t5a4K3g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* 1. 기본 초기화 */
        * {
            box-sizing: border-box
        }

        body {
            margin: 20px;
            background-color: #f5f5f5;
            font-family: sans-serif;

            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 500px;
            height: 600px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;

            overflow: hidden;
        }

        /* 헤더 */
        .header {
            background-color: #3b5998;
            color: white;
            text-align: center;
            padding: 15px;
        }

        /* 채팅 목록 영역 */
        .chat-box {
            flex: 1;
            background-color: white;
            overflow-y: auto;
            padding: 20px;
        }

        /* 개별 메세지 디자인 */
        .msg-box {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .name {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .msg {
            background-color: #e9e9eb;
            padding: 10px 15px;

            border-radius: 15px;
            border-top-left-radius: 0;

            font-size: 14px;
            max-width: 80%;

            white-space: pre-wrap;
        }

        /* input area */
        .input-area {
            background-color: #f0f2f5;
            padding: 15px;
            border-top: 1px solid #ddd;

            display: flex;
            gap: 10px;
        }

        .input-sender {
            width: 80px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .input-msg {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            outline: none;
        }

        .btn-send {
            background-color: #3b5998;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h3>WebSocket 채팅방</h3>
        <p>실시간 채팅 - 양방향 전이중 통신</p>
    </div>

    <div class="chat-box" id="chatBox">
        <!-- 반복 시작 -->
        {{#chatList}}
            <div class="msg-wrap">
                <div class="msg-box">
                    <span class="name">{{sender}}</span>
                    <span class="msg">{{message}}</span>
                </div>
            </div>
            <!-- 반복 종료 -->
        {{/chatList}}
    </div>

    <form id="chatForm" class="input-area">
        <input type="text" id="sender" name="sender" value="익명" class="input-sender" required>
        <input type="text" id="message" name="message" placeholder="내용 입력..." class="input-msg" autofocus>
        <button type="submit" class="btn-send">전송</button>
    </form>
</div>

<script>
    const chatBox = document.getElementById("chatBox");
    const chatForm = document.getElementById("chatForm");

    // 스크롤 바닥 고정
    chatBox.scrollTop = chatBox.scrollHeight;

    let stompClient = null;

    // 1. 연결 요청 함수 선언(핸드셰이크)
    function connect() {
        // SockJS는 웹 소켓을 지원하지 않는 브라우저에 웹소켓을 사용하도록 지원하는 녀석
        // SockJS를 사용해서 서버측 웹 소켓 엔드포인트와 연결을 시도함
        const socket = new SockJS("/ws-stomp");

        // 생성된 SockJS 객체 위에 Stomp 프로토콜을 얹음 (안정성을 위해)
        stompClient = Stomp.over(socket);

        // 콜백 메서드 등록 및 핸들러 처리
        // stompClient.connect(header, onConnected, onError(옵션))
        // 1번째 인수:
        // let headers = {
        //   'Authorization' : "Bearer "
        // };
        stompClient.connect({}, function (frame) {
            // 2번째 인수: 연결이 성공하면 어떤 일을 수행해 !
            console.log(frame);

            // 구독 설정
            // - /sub/chat/room1 경로를 구독합니다
            stompClient.subscribe('/sub/chat/room1', function (res) {
               // 메세지가 오면 화면에 표시할 예정
                showMessage(res.body);
            });
        });
    } // end of connect

    function showMessage(msg) {
        // "홍길동:메세지" 형태로 들어옴
        const separatorIndex = msg.indexOf(":");
        let sender = "알 수 없음";
        let message = msg;

        if (separatorIndex !== -1) {
            sender = msg.substring(0, separatorIndex);
            message = msg.substring(separatorIndex + 1);
        }

        const msgWrap = document.createElement("div");
        msgWrap.className = 'msg-wrap';

        const msgBox = document.createElement("div");
        msgBox.className = 'msg-box';

        const nameSpan = document.createElement("span");
        nameSpan.className = 'name';
        nameSpan.textContent = sender; // 값 할당

        const msgSpan = document.createElement("span");
        msgSpan.className = 'msg';
        msgSpan.textContent = message; // 값 할당

        // 조립
        msgBox.appendChild(nameSpan);
        msgBox.appendChild(msgSpan);
        msgWrap.appendChild(msgBox);
        chatBox.appendChild(msgWrap);
        // 스크롤 바닥 고정
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 서버측으로 stomp 이용해서 메세지를 전송
    function sendMessage(sender, message) {
        if (stompClient != null) {

            // "send:message" --> JSON 형식으로 보내기
            // 자바스크립트 {리터럴 객체} 생성 후 JSON.stringify(jsObject)
            const payload = {
              'sender': sender,
              'message': message
            }; // 리터럴 객체 생성 완료

            stompClient.send("/pub/chat/message", {}, JSON.stringify(payload)); // 컨트롤러로 보냄
        }
    }


    // 자바스크립트로 폼 제출 이벤트
    chatForm.addEventListener("submit", function (e) {
       e.preventDefault(); // form 태그의 기존 submit 이벤트 막기

        const sender = document.getElementById("sender").value;
        const messageInput = document.getElementById("message");
        const message = messageInput.value;

        // 공백을 제거하고 값 (글자가) 있다면
        if (message.trim()) {
            sendMessage(sender, message);
            // UI 초기화
            messageInput.value = "";
            messageInput.focus();
        }
    });


    // 함수 호출
    connect();

</script>
</body>
</html>

