<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document</title>
    <style>
    /* 1. 기본 초기화 */
    * { box-sizing: border-box }
    body {
        margin: 20px;
        background-color: #f5f5f5;
        font-family: sans-serif;

        display: flex;
        justify-content: center;
        align-items: center;
    }

    .container {
        width: 500px;
        height: 600px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;

        overflow: hidden;
    }

    /* 헤더 */
    .header {
        background-color: #3b5998;
        color: white;
        text-align: center;
        padding: 15px;
    }

    /* 채팅 목록 영역 */
    .chat-box {
        flex: 1;
        background-color: white;
        overflow-y: auto;
        padding: 20px;
    }

    /* 개별 메세지 디자인 */
    .msg-box {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 15px;
    }

    .name {
        font-size: 12px;
        color: #888;
        margin-bottom: 5px;
    }

    .msg {
        background-color: #e9e9eb;
        padding: 10px 15px;

        border-radius: 15px;
        border-top-left-radius: 0;

        font-size: 14px;
        max-width: 80%;

        white-space: pre-wrap;
    }

    /* input area */
    .input-area {
        background-color: #f0f2f5;
        padding: 15px;
        border-top: 1px solid #ddd;

        display: flex;
        gap: 10px;
    }

    .input-sender {
        width: 80px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .input-msg {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        outline: none;
    }

    .btn-send {
        background-color: #3b5998;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h3>SSE 채팅방</h3>
            <p>실시간 채팅 - 푸쉬서버</p>
        </div>

        <div class="chat-box" id="chatBox">
            <!-- 반복 시작 -->
            {{#chatList}}
            <div class="msg-wrap">
                <div class="msg-box">
                    <span class="name">{{sender}}</span>
                    <span class="msg">{{message}}</span>
                </div>
            </div>
            <!-- 반복 종료 -->
            {{/chatList}}
        </div>

        <form id="chatForm" class="input-area">
            <input type="text" id="sender" name="sender" value="익명" class="input-sender" required>
            <input type="text" id="message" name="message" placeholder="내용 입력..." class="input-msg" autofocus>
            <button type="submit" class="btn-send">전송</button>
        </form>
    </div>

<script>
// 3초마다 서버에 새로운 데이터가 있니? 요청하는 방식
// 1. 화면에 스크롤 바닥 고정(대화가 많아지면)
const chatBox = document.getElementById("chatBox");
const chatForm = document.getElementById("chatForm");
chatBox.scrollTop = chatBox.scrollHeight; // 0이면 최상단, scrollHeight는 chatBox의 크기만큼 알아서 지정됨

// 2. SSE 연결 설정
// - EventSource js API (SSE 처리하기 위해 제공)
// 하나의 논리적인 연결지속되는 선을 요청함
// /see/connect - 서버와 클라이언트 간의 약속(프로토콜)
const eventSource = new EventSource("/sse/connect");
eventSource.onopen = () => console.log("SSE 연결 성공");
eventSource.onerror = () => console.log("SSE 연결 에러 (자동연결 재시도)");
// 페이지 종료 시 연결 종료
window.addEventListener("beforeunload", () => {
    eventSource.close();
})

eventSource.addEventListener('newMessage', (event) => {
    // (서버가보낼) 데이터 형식 : "Sender: Message"
    const rawData = event.data;

    // ex) 홍길동:안녕하세요
    const separatorIndex = rawData.indexOf(":") // 인덱스 번호
    let sender = "익명";
    let message = rawData;

    if (separatorIndex !== -1) { // 넘겨받은 문자열에 : 이 없으면 -1 - 공백도 하나의 index
        sender = rawData.substring(0, separatorIndex);
        message = rawData.substring(separatorIndex + 1); // formattedMessage 공백있으면 + 2 해야함
    }

    // DOM 요소 생성
    const msgWrap = document.createElement("div");
    msgWrap.className = "msg-wrap";

    const msgBox = document.createElement("div");
    msgBox.className = "msg-box";

    const nameSpan = document.createElement("span");
    nameSpan.className = "name";
    nameSpan.textContent = sender; // 값 주입

    const msgSpan = document.createElement("span");
    msgSpan.className = "msg";
    msgSpan.textContent = message; // 넘겨받은 메세지 값 주입

    // 조립
    msgBox.appendChild(nameSpan);
    msgBox.appendChild(msgSpan);

    msgWrap.appendChild(msgBox);

    // 채팅창에 요소 추가
    chatBox.appendChild(msgWrap);

    chatBox.scrollTop = chatBox.scrollHeight; // 스크롤 바닥으로 이동
});

// form 기본 이벤트 제거
chatForm.addEventListener("submit", function (e) {
   e.preventDefault(); // 기본 submit 이벤트 방지 (새로고침 방지)

    const senderInput = document.getElementById("sender");
    const messageInput = document.getElementById("message");

    // 텍스트만 필요하니까
    const sender = senderInput.value;
    const message = messageInput.value;

    if (!message.trim()) {
        alert("메세지는 반드시 입력해야합니다");
        return;
    }

    // fetch 비동기 통신 처리
    fetch("/sse/send", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        // 폼 데이터 형식(key=value)으로 변환 ---> sender="홍길동"&message="..."
        body: new URLSearchParams({
          sender: sender,
          message: message
        })
    })

            .then(response => {
                // 전송 성공 시 입력창 비우기
                if (response.ok) {
                    messageInput.value = "";
                    messageInput.focus();
                } else {
                    console.log("전송 실패");
                }
            })
            .catch(error => console.log("에러 발생 : ", error));
});

</script>

</body>
</html>

